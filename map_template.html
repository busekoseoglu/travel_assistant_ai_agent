<!DOCTYPE html>
<html>
<head>
    <title>Discovery Plan Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet Library (CSS and JavaScript) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100%; width: 100%; }
        .leaflet-popup-content-wrapper { border-radius: 5px; }
        .leaflet-popup-content b { font-size: 1.1em; }
        .leaflet-popup-content a { color: #0078A8; text-decoration: none; }
        .leaflet-popup-content a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<div id="map" style="height: 600px;"></div>
<script>
    // JSON DATA FROM PYTHON WILL BE INJECTED HERE
    const jsonData = %JSON_DATA%;

    const plan = jsonData.discovery_plan;
    const error = jsonData.error;

    // If there is no plan data or an error exists, display a message instead of the map.
    if (!plan || error) {
        const mapDiv = document.getElementById('map');
        mapDiv.style.display = 'flex';
        mapDiv.style.alignItems = 'center';
        mapDiv.style.justifyContent = 'center';
        mapDiv.innerHTML = `<h2 style="text-align:center; color: #d9534f;">Could not load map: ${error || 'Plan data not found.'}</h2>`;
    } else {
        try {
            // Initialize the map and center it on the anchor point.
            const map = L.map('map').setView([plan.anchor_point.coords.lat, plan.anchor_point.coords.lng], 13);
            
            // Add the map layer (OpenStreetMap - free).
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Function to create colored markers.
            const createColorIcon = (color) => new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            
            const greenIcon = createColorIcon('green');   // Anchor Point
            const redIcon = createColorIcon('red');       // Restaurants
            const blueIcon = createColorIcon('blue');     // Attractions
            const yellowIcon = createColorIcon('yellow'); // City Center

            // 1. Add the City Center marker to the map.
            if (plan.city_center && plan.city_center.coords) {
                L.marker([plan.city_center.coords.lat, plan.city_center.coords.lng], {icon: yellowIcon, zIndexOffset: 900})
                  .addTo(map)
                  .bindPopup(`<b>üìç ${plan.city_center.name}</b>`);
            }
            
            // 2. Add the Anchor Point marker to the map.
            const anchor = plan.anchor_point;
            if (anchor && anchor.coords) {
                L.marker([anchor.coords.lat, anchor.coords.lng], {icon: greenIcon, zIndexOffset: 1000})
                  .addTo(map)
                  .bindPopup(`<b>‚≠ê STARTING POINT ‚≠ê</b><br><b><a href="${anchor.link}" target="_blank">${anchor.name}</a></b>`);
            }

            // 3. Add restaurant suggestions to the map.
            plan.restaurant_suggestions.forEach(resto => {
                if(resto && resto.coords) {
                    let popupContent = `<b>üçΩÔ∏è <a href="${resto.link}" target="_blank">${resto.name}</a></b><br>Rating: ${resto.rating || 'N/A'} ‚≠ê`;
                    if (resto.price_label) {
                        popupContent += `<br>Price: <b>${resto.price_label}</b>`;
                    }
                    L.marker([resto.coords.lat, resto.coords.lng], {icon: redIcon})
                      .addTo(map)
                      .bindPopup(popupContent);
                }
            });
            
            // 4. Add attraction suggestions to the map.
            plan.attraction_suggestions.forEach(att => {
                if(att && att.coords) {
                    L.marker([att.coords.lat, att.coords.lng], {icon: blueIcon})
                      .addTo(map)
                      .bindPopup(`<b>üö∂‚Äç‚ôÇÔ∏è <a href="${att.link}" target="_blank">${att.name}</a></b><br>Rating: ${att.rating || 'N/A'} ‚≠ê`);
                }
            });

            // 5. Add route lines.
            if (anchor && anchor.coords) {
                const anchorCoords = [anchor.coords.lat, anchor.coords.lng];
                
                // Draw dashed lines from the anchor point to restaurants.
                plan.restaurant_suggestions.forEach(resto => {
                    if (resto && resto.coords) {
                        L.polyline([anchorCoords, [resto.coords.lat, resto.coords.lng]], { color: '#c9302c', weight: 2, opacity: 0.7, dashArray: '5, 10' }).addTo(map);
                    }
                });

                // Draw dashed lines from the anchor point to attractions.
                plan.attraction_suggestions.forEach(att => {
                    if (att && att.coords) {
                         L.polyline([anchorCoords, [att.coords.lat, att.coords.lng]], { color: '#337ab7', weight: 2, opacity: 0.7, dashArray: '5, 10' }).addTo(map);
                    }
                });
            }

            // 6. Adjust the map to fit all markers.
            const allCoords = [];
            if (plan.city_center && plan.city_center.coords) allCoords.push([plan.city_center.coords.lat, plan.city_center.coords.lng]);
            if (anchor && anchor.coords) allCoords.push([anchor.coords.lat, anchor.coords.lng]);
            plan.restaurant_suggestions.forEach(r => { if(r.coords) allCoords.push([r.coords.lat, r.coords.lng]) });
            plan.attraction_suggestions.forEach(a => { if(a.coords) allCoords.push([a.coords.lat, a.coords.lng]) });

            if (allCoords.length > 1) {
                map.fitBounds(allCoords, { padding: [50, 50] });
            }
        } catch (e) {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `<h2 style="text-align:center; color: #d9534f;">An error occurred while rendering the map: ${e.message}</h2>`;
        }
    }
</script>

</body>
</html>